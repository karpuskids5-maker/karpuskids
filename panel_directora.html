<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Karpus Kids ‚Äî Panel Director</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="js/auth.js?v=1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  
  <style>
    /* Sidebar styles */
    aside#sidebar { width: 280px; transition: width .25s ease, transform .25s ease; }
    aside#sidebar.collapsed { width: 72px; }
    aside#sidebar .label { transition: opacity .2s ease; }
    aside#sidebar.collapsed .label { opacity: 0; }
    
    /* Hover expand logic */
    aside#sidebar.collapsed:hover { width: 280px; }
    aside#sidebar.collapsed:hover .label { opacity: 1; }
    aside#sidebar.collapsed:hover .badge { opacity: 1; }
    aside#sidebar.collapsed .badge { opacity: 0; transition: opacity .2s; }

    /* mobile helper */
    .hidden-mobile { display: none !important; }
    /* color variants */
    .sidebar-indigo { background: linear-gradient(135deg,#EEF2FF,#E0E7FF); }
    .sidebar-blue { background: linear-gradient(135deg,#E3F2FD,#BBDEFB); }
    .sidebar-green { background: linear-gradient(135deg,#E8F8F0,#D0F0E0); }
    .sidebar-purple { background: linear-gradient(135deg, #7c3aed, #4f46e5); }
    .glass { background: rgba(255,255,255,0.6); backdrop-filter: blur(6px); }
    .sidebar-scroll { max-height: calc(100vh - 4rem); overflow:auto; }
    /* Karpus colored letters small */
    .karpus-kids-inline { font-weight: 700; }
    .karpus-kids-inline .k-1 { color: #FF9800; }
    .karpus-kids-inline .k-2 { color: #2196F3; }
    .karpus-kids-inline .k-3 { color: #E91E63; }
    .karpus-kids-inline .k-4 { color: #4CAF50; }
    .karpus-kids-inline .k-5 { color: #FF9800; }
    .karpus-kids-inline .k-6 { color: #2196F3; }
    .karpus-kids-inline .k-7 { color: #4CAF50; }
    .karpus-kids-inline .k-8 { color: #E91E63; }
    .karpus-kids-inline .k-9 { color: #2196F3; }
    .karpus-kids-inline .k-10 { color: #FF9800; }
    
    /* Estilos para modales m√°s grandes y profesionales */
    .modal-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .modal-container.active {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-content {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }
    
    .modal-container.active .modal-content {
      transform: scale(1);
    }
    
    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }
    
    /* Estilos para botones de navegaci√≥n */
    .nav-btn {
      width: 100%;
      text-align: left;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .nav-btn i {
      transition: color 0.2s ease;
    }
    
    .nav-btn .badge {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: #e91e63;
      color: white;
      border-radius: 9999px;
      font-size: 0.75rem;
      padding: 0.125rem 0.375rem;
      min-width: 1.5rem;
      text-align: center;
    }

    /* Animaci√≥n suave para reportes */
    .report-details {
      display: grid;
      grid-template-rows: 0fr;
      transition: grid-template-rows 0.3s ease-out;
    }
    .report-details.open {
      grid-template-rows: 1fr;
    }
    .report-details > div {
      overflow: hidden;
    }

    /* Layout adjustments */
    #layoutShell { transition: margin-left .25s ease; }
    #layoutShell.sidebar-collapsed { margin-left: 72px !important; }
    
    @media (max-width: 768px) {
      #layoutShell { margin-left: 0 !important; }
    }

    /* Chips para resumen de pagos */
    .chip { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
    .chip-blue { background-color: #dbeafe; color: #1e40af; }
    .chip-green { background-color: #dcfce7; color: #166534; }
    .chip-orange { background-color: #ffedd5; color: #9a3412; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 font-nunito">
  <div class="min-h-screen flex">
    <!-- SIDEBAR -->
    <aside id="sidebar" class="hidden md:block sidebar-purple p-4 rounded-r-3xl shadow-lg fixed inset-y-0 left-0 z-10">
      <button id="toggleSidebar" class="absolute -right-3 top-6 bg-white rounded-full p-1 shadow-md border border-slate-100 text-slate-500 hover:text-purple-600 hidden md:block"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
      <div class="flex items-center gap-3 mb-6">
        <div class="h-12 w-12 rounded-2xl bg-white/20 flex items-center justify-center shadow-lg">
          <img src="img/mundo.jpg" alt="logo" class="h-10 w-10 rounded-lg object-cover" />
        </div>
        <div class="label">
          <h3 class="font-semibold text-white"><span class="karpus-kids-inline"><span class="k-1">K</span><span class="k-2">a</span><span class="k-3">r</span><span class="k-4">p</span><span class="k-5">u</span><span class="k-6">s</span> <span class="k-7">K</span><span class="k-8">i</span><span class="k-9">d</span><span class="k-10">s</span></span></h3>
          <p class="text-xs text-white text-opacity-80">Panel - Director(a)</p>
        </div>
      </div>

      <div class="sidebar-scroll">
      <nav class="space-y-2 teams-nav bg-white/10 p-2 rounded-xl mb-4">
        <button data-section="dashboard" class="nav-btn teams-nav-item text-white hover:bg-white/20" title="Dashboard">
          <i data-lucide="grid" class="text-karpus-blue"></i>
          <span class="label">Dashboard</span>
        </button>
        <button data-section="maestros" class="nav-btn teams-nav-item text-white hover:bg-white/20" title="Maestros">
          <i data-lucide="users" class="text-karpus-green"></i>
          <span class="label">Maestros</span>
          <span class="badge">5</span>
        </button>
        <button data-section="estudiantes" class="nav-btn teams-nav-item text-white hover:bg-white/20" title="Estudiantes">
          <i data-lucide="user-check" class="text-karpus-orange"></i>
          <span class="label">Estudiantes</span>
          <span class="badge">24</span>
        </button>
        <button data-section="aulas" class="nav-btn teams-nav-item text-white hover:bg-white/20" title="Aulas">
          <i data-lucide="home" class="text-karpus-purple"></i>
          <span class="label">Aulas</span>
        </button>
        <button data-section="asistencia" class="nav-btn teams-nav-item text-white hover:bg-white/20" title="Asistencia">
          <i data-lucide="calendar" class="text-karpus-pink"></i>
          <span class="label">Asistencia</span>
        </button>
        <button data-section="calificaciones" class="nav-btn teams-nav-item text-white hover:bg-white/20" title="Calificaciones">
          <i data-lucide="graduation-cap" class="text-karpus-teal"></i>
          <span class="label">Calificaciones</span>
        </button>
        <button data-section="reportes" class="nav-btn teams-nav-item text-white hover:bg-white/20" title="Reportes">
          <i data-lucide="file-text" class="text-karpus-indigo"></i>
          <span class="label">Reportes</span>
        </button>
        <button data-section="pagos" class="nav-btn teams-nav-item text-white hover:bg-white/20" title="Pagos">
          <i data-lucide="credit-card" class="text-karpus-yellow"></i>
          <span class="label">Pagos</span>
        </button>
        <button data-section="comunicacion" class="nav-btn teams-nav-item text-white hover:bg-white/20" title="Comunicaciones">
          <i data-lucide="message-square" class="text-karpus-blue"></i>
          <span class="label">Comunicaciones</span>
          <span class="badge">3</span>
        </button>
        <button data-section="configuracion" class="nav-btn teams-nav-item text-white hover:bg-white/20" title="Configuraci√≥n">
          <i data-lucide="settings" class="text-karpus-gray"></i>
          <span class="label">Configuraci√≥n</span>
        </button>
      </nav>

      <!-- Color sidebar eliminado: se usa estilo √∫nico -->
      <div class="mt-6 text-xs text-white/80">
        <p>Usuario: <span class="font-medium">Director(a)</span></p>
        <p class="mt-2">√öltimo acceso: <span class="font-medium">Hoy</span></p>
      </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="flex-1 p-6 ml-[280px]" id="layoutShell">
      <!-- Topbar mobile -->
      <div class="md:hidden mb-4 flex items-center justify-between">
        <button id="menuBtn" class="p-2 rounded bg-white shadow"><i data-lucide="menu" class="lucide"></i></button>
        <h2 class="font-semibold">Panel Director</h2>
        <div class="flex items-center gap-2">
          <button class="p-2 rounded bg-white shadow"><i data-lucide="bell" class="lucide"></i></button>
          <img src="img/mundo.jpg" class="rounded-full w-9 h-9 object-cover" alt="avatar">
        </div>
      </div>

      <!-- SECTIONS -->
      <section id="dashboard" class="section">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <i data-lucide="layout-dashboard" class="w-7 h-7 text-blue-600"></i>
            <h1 class="text-2xl font-bold">Resumen general</h1>
            <p class="text-sm text-slate-500">Visi√≥n r√°pida de la estancia</p>
          </div>
          <div class="flex items-center gap-3">
            <button onclick="exportDashboardData()" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors flex items-center gap-2"><i data-lucide="download" class="w-4 h-4"></i> Exportar datos</button>
            <button onclick="openTeacherModal()" class="px-3 py-2 border rounded hover:bg-slate-50 transition-colors flex items-center gap-2"><i data-lucide="user-plus" class="w-4 h-4"></i> Crear maestro</button>
          </div>
        </div>

        <!-- ALERTAS AUTOM√ÅTICAS (Notificaciones) -->
        <div id="dashboardAlerts" class="mb-6 hidden"></div>

        <!-- cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <!-- Card 1: Ni√±os Presentes -->
          <div class="p-4 bg-blue-100 text-blue-800 rounded-2xl shadow flex items-center gap-4">
            <div class="bg-blue-500 text-white p-3 rounded-xl">
              <i data-lucide="smile" class="w-8 h-8"></i>
            </div>
            <div>
              <p class="text-sm">Ni√±os presentes</p>
              <p id="ninosPresentes" class="text-2xl font-bold">24</p>
            </div>
          </div>
          <!-- Card 2: Maestros Activos -->
          <div class="p-4 bg-green-100 text-green-800 rounded-2xl shadow flex items-center gap-4">
            <div class="bg-green-500 text-white p-3 rounded-xl">
              <i data-lucide="user-check" class="w-8 h-8"></i>
            </div>
            <div>
              <p class="text-sm">Maestros activos</p>
              <p id="maestrosActivos" class="text-2xl font-bold">7</p>
            </div>
          </div>
          <!-- Card 3: Solicitudes -->
          <div class="p-4 bg-orange-100 text-orange-800 rounded-2xl shadow flex items-center gap-4">
            <div class="bg-orange-500 text-white p-3 rounded-xl">
              <i data-lucide="inbox" class="w-8 h-8"></i>
            </div>
            <div>
              <p class="text-sm">Solicitudes hoy</p>
              <p id="solicitudesHoy" class="text-2xl font-bold">3</p>
            </div>
          </div>
          <!-- Card 4: Aulas -->
          <div class="p-4 bg-purple-100 text-purple-800 rounded-2xl shadow flex items-center gap-4">
            <div class="bg-purple-500 text-white p-3 rounded-xl">
              <i data-lucide="home" class="w-8 h-8"></i>
            </div>
            <div>
              <p class="text-sm">Aulas ocupadas</p>
              <p id="aulasOcupadas" class="text-2xl font-bold">5/6</p>
            </div>
          </div>
          <!-- Card 5: Eventos (Nuevo) -->
          <div class="p-4 bg-pink-100 text-pink-800 rounded-2xl shadow flex items-center gap-4 sm:col-span-2 lg:col-span-4">
            <div class="bg-pink-500 text-white p-3 rounded-xl">
              <i data-lucide="calendar-heart" class="w-8 h-8"></i>
            </div>
            <div class="flex-1">
              <p class="text-sm font-semibold">Eventos del Mes</p>
              <p class="text-sm">üéÇ Cumplea√±os de <span class="font-bold">Ana Sof√≠a</span> (Ma√±ana) ‚Ä¢ üé≠ Obra de teatro (Viernes 15)</p>
            </div>
          </div>
        </div>

        <!-- charts + tabla resumen -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="col-span-2 bg-white rounded shadow p-4">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-semibold">Estad√≠sticas de Asistencia</h3>
              <div class="flex bg-slate-100 rounded-lg p-1 gap-1">
                <button onclick="updateChart('day')" class="px-3 py-1 text-xs rounded-md bg-white shadow-sm text-slate-700 font-medium transition-all hover:bg-white/80">D√≠a</button>
                <button onclick="updateChart('week')" class="px-3 py-1 text-xs rounded-md text-slate-500 hover:bg-white hover:shadow-sm transition-all">Semana</button>
                <button onclick="updateChart('month')" class="px-3 py-1 text-xs rounded-md text-slate-500 hover:bg-white hover:shadow-sm transition-all">Mes</button>
              </div>
            </div>
            <canvas id="attendanceChart" height="120"></canvas>
          </div>

          <div class="bg-white rounded shadow p-4">
            <h3 class="font-semibold mb-3">√öltimas evaluaciones</h3>
            <table class="w-full text-sm">
              <thead class="text-slate-500 text-left">
                <tr><th>Estudiante</th><th>Aula</th><th>Nota</th></tr>
              </thead>
              <tbody id="evaluacionesList">
                <tr><td>Mar√≠a P.</td><td>A1</td><td>Excelente</td></tr>
                <tr><td>Javier R.</td><td>A2</td><td>Bueno</td></tr>
                <tr><td>Sofia L.</td><td>A1</td><td>Muy bueno</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Log de Actividad Biom√©trica Reciente -->
        <div class="mt-6 bg-white rounded shadow p-4">
            <h3 class="font-semibold mb-3">Actividad Biom√©trica Reciente</h3>
            <div id="biometricLog" class="space-y-2 text-sm max-h-48 overflow-y-auto">
                <div class="flex justify-between items-center p-2 rounded bg-green-50">
                    <p><strong>Entrada:</strong> Mar√≠a P. (Aula A1)</p>
                    <span class="text-xs text-slate-500">8:15 AM</span>
                </div>
                <div class="flex justify-between items-center p-2 rounded bg-green-50">
                    <p><strong>Entrada:</strong> Javier R. (Aula A2)</p>
                    <span class="text-xs text-slate-500">8:07 AM</span>
                </div>
            </div>
        </div>

      </section>

      <!-- MAESTROS -->
      <section id="maestros" class="section hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            <i data-lucide="users" class="w-5 h-5 text-slate-600"></i><span>Maestros</span>
          </h2>
          <div>
            <button onclick="openTeacherModal()" class="px-3 py-2 bg-green-600 text-white rounded">Agregar maestro</button>
          </div>
        </div>
        <div class="bg-white rounded shadow p-4">
          <table class="w-full text-sm">
            <thead class="text-slate-500 text-left">
              <tr>
                <th class="py-2">Nombre</th>
                <th class="py-2">Correo</th>
                <th class="py-2">Tel√©fono</th>
                <th class="py-2">Estado</th>
                <th class="py-2">Acciones</th>
              </tr>
            </thead>
            <tbody id="teachersTable"><!-- Se llena din√°micamente con JS --></tbody>
          </table>
        </div>
      </section>

      <!-- ESTUDIANTES -->
      <section id="estudiantes" class="section hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            <i data-lucide="users" class="w-5 h-5 text-slate-600"></i><span>Estudiantes</span>
          </h2>
          <div class="flex gap-2">
            <input id="searchStudent" placeholder="Buscar estudiante..." class="px-3 py-2 border rounded-lg" />
            <button onclick="openAddStudentModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center gap-2">
              <i data-lucide="user-plus" class="w-4 h-4"></i>
              Agregar Estudiante
            </button>
          </div>
        </div>

        <!-- Tabla de estudiantes simplificada -->
        <div class="bg-white rounded-lg shadow p-6">
          <div class="mb-4">
            <h3 class="text-lg font-medium text-slate-800 mb-2">Lista de Estudiantes</h3>
            <p class="text-sm text-slate-600">Haga clic en "Ver Perfil" para acceder a los datos de los padres</p>
          </div>
          
          <table class="w-full">
            <thead class="bg-slate-50">
              <tr>
                <th class="text-left py-3 px-4 font-medium text-slate-700">Nombre del Estudiante</th>
                <th class="text-center py-3 px-4 font-medium text-slate-700">Acciones</th>
              </tr>
            </thead>
            <tbody id="studentsTable" class="divide-y divide-slate-200">
              <tr class="hover:bg-slate-50">
                <td class="py-4 px-4">
                  <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center">
                      <i data-lucide="user" class="w-4 h-4 text-indigo-600"></i>
                    </div>
                    <span class="font-medium text-slate-800">Mar√≠a Fernanda P√©rez</span>
                  </div>
                </td>
                <td class="py-4 px-4 text-center">
                  <button onclick="viewStudentProfile(this)" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm font-medium">
                    Ver Perfil
                  </button>
                </td>
              </tr>
              <tr class="hover:bg-slate-50">
                <td class="py-4 px-4">
                  <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                      <i data-lucide="user" class="w-4 h-4 text-green-600"></i>
                    </div>
                    <span class="font-medium text-slate-800">Javier Alejandro Rodr√≠guez</span>
                  </div>
                </td>
                <td class="py-4 px-4 text-center">
                  <button onclick="viewStudentProfile(this)" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm font-medium">
                    Ver Perfil
                  </button>
                </td>
              </tr>
              <tr class="hover:bg-slate-50">
                <td class="py-4 px-4">
                  <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                      <i data-lucide="user" class="w-4 h-4 text-purple-600"></i>
                    </div>
                    <span class="font-medium text-slate-800">Ana Sof√≠a Gonz√°lez</span>
                  </div>
                </td>
                <td class="py-4 px-4 text-center">
                  <button onclick="viewStudentProfile(this)" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm font-medium">
                    Ver Perfil
                  </button>
                </td>
              </tr>
              <tr class="hover:bg-slate-50">
                <td class="py-4 px-4">
                  <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center">
                      <i data-lucide="user" class="w-4 h-4 text-orange-600"></i>
                    </div>
                    <span class="font-medium text-slate-800">Carlos Eduardo Mart√≠nez</span>
                  </div>
                </td>
                <td class="py-4 px-4 text-center">
                  <button onclick="viewStudentProfile(this)" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm font-medium">
                    Ver Perfil
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- AULAS -->
      <section id="aulas" class="section hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            <i data-lucide="home" class="w-5 h-5 text-slate-600"></i><span>Aulas</span>
          </h2>
          <div>
            <button onclick="openRoomModal()" class="px-3 py-2 bg-yellow-600 text-white rounded">Nueva aula</button>
          </div>
        </div>
        
        <!-- Tabla de aulas -->
        <div class="bg-white rounded shadow p-4">
          <table class="w-full text-sm">
            <thead class="text-slate-500 text-left">
              <tr>
                <th class="py-2">Nombre del Aula</th>
                <th class="py-2 hidden md:table-cell">Maestro Asignado</th>
                <th class="py-2">Ocupaci√≥n</th>
                <th class="py-2 text-center">Estado</th>
                <th class="py-2">Acciones</th>
              </tr>
            </thead>
            <tbody id="roomsTable"><!-- Llenado din√°micamente por JS --></tbody>
          </table>
        </div>
      </section>

      <!-- ASISTENCIA -->
      <section id="asistencia" class="section hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            <i data-lucide="calendar-check" class="w-5 h-5 text-slate-600"></i><span>Control de Asistencia</span>
          </h2>
          <div class="flex gap-2">
            <input type="date" class="px-3 py-2 border rounded text-sm" value="2024-01-06">
            <button id="exportAttendance" class="px-3 py-2 border rounded">Exportar</button>
          </div>
        </div>
        <div class="bg-white rounded shadow p-4">
          <div class="flex justify-between items-center mb-3">
            <p class="text-sm text-slate-500">Marcar / corregir asistencia del d√≠a</p>
            <button onclick="markAllPresent()" class="text-sm text-blue-600 hover:underline">Marcar todos presente</button>
          </div>
          <table class="w-full text-sm">
            <thead class="text-slate-500 text-left"><tr><th>Estudiante</th><th>Aula</th><th>Estado</th><th>Acciones</th></tr></thead>
            <tbody id="attendanceListBody">
              <tr><td>Mar√≠a P.</td><td>A1</td><td><select class="border rounded px-2 py-1 attendance-select"><option value="Presente">Presente</option><option value="Ausente">Ausente</option><option value="Excusa">Excusa M√©dica</option></select></td><td><button class="text-blue-600 hover:text-blue-800"><i data-lucide="save" class="w-4 h-4"></i></button></td></tr>
              <tr><td>Javier R.</td><td>A2</td><td><select class="border rounded px-2 py-1 attendance-select"><option value="Presente">Presente</option><option value="Ausente">Ausente</option><option value="Excusa">Excusa M√©dica</option></select></td><td><button class="text-blue-600 hover:text-blue-800"><i data-lucide="save" class="w-4 h-4"></i></button></td></tr>
              <tr><td>Ana Sof√≠a G.</td><td>A1</td><td><select class="border rounded px-2 py-1 attendance-select"><option value="Presente">Presente</option><option value="Ausente">Ausente</option><option value="Excusa">Excusa M√©dica</option></select></td><td><button class="text-blue-600 hover:text-blue-800"><i data-lucide="save" class="w-4 h-4"></i></button></td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- CALIFICACIONES -->
      <section id="calificaciones" class="section hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            <i data-lucide="graduation-cap" class="w-5 h-5 text-slate-600"></i><span>Calificaciones</span>
          </h2>
          <div class="flex gap-2">
            <select id="gradesFilter" class="px-3 py-2 border rounded text-sm" onchange="renderGrades()">
              <option value="all">Todas las aulas</option>
              <option value="Peque√±os">Peque√±os</option>
              <option value="Medianos">Medianos</option>
              <option value="Grandes">Grandes</option>
            </select>
            <button onclick="alert('Exportando calificaciones...')" class="px-3 py-2 border rounded hover:bg-slate-50 text-sm">Exportar</button>
          </div>
        </div>
        
        <div class="bg-white rounded shadow p-4">
          <table class="w-full text-sm">
            <thead class="text-slate-500 text-left bg-slate-50">
              <tr><th class="p-3">Estudiante</th><th class="p-3">Aula</th><th class="p-3">Matem√°ticas</th><th class="p-3">Lenguaje</th><th class="p-3">Arte</th><th class="p-3">Promedio</th><th class="p-3">Estado</th></tr>
            </thead>
            <tbody id="gradesTable"><!-- Llenado por JS --></tbody>
          </table>
        </div>
      </section>

      <!-- REPORTES Y QUEJAS -->
      <section id="reportes" class="section hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            <i data-lucide="alert-triangle" class="w-5 h-5 text-slate-600"></i><span>Reportes y Quejas</span>
          </h2>
          <div class="flex gap-2">
            <select id="reportFilter" class="px-3 py-2 border rounded">
              <option value="all">Todos los reportes</option>
              <option value="pending">Pendientes</option>
              <option value="resolved">Resueltos</option>
              <option value="teachers">De Maestros</option>
              <option value="parents">De Padres</option>
            </select>
            <button id="refreshReports" class="px-3 py-2 bg-blue-600 text-white rounded">Actualizar</button>
          </div>
        </div>
        
        <!-- Lista de reportes/quejas -->
        <div class="space-y-4">
          <!-- Reporte ejemplo 1 -->
          <div class="bg-white rounded shadow p-4 border-l-4 border-red-500">
            <div class="flex items-start justify-between mb-3">
              <div>
                <h3 class="font-semibold text-red-700">Queja - Comportamiento en el aula</h3>
                <p class="text-sm text-slate-600">
                  <span class="font-medium">De:</span> Mar√≠a Gonz√°lez (Madre de Ana L√≥pez) ‚Ä¢ 
                  <span class="font-medium">Fecha:</span> 15 Dic 2024, 10:30 AM
                </p>
              </div>
              <div class="flex gap-2">
                <span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs">Pendiente</span>
                <button onclick="toggleReportDetails(this)" class="text-blue-600 hover:text-blue-800 text-sm">Ver detalles</button>
              </div>
            </div>
            <p class="text-sm text-slate-700 mb-3">
              Mi hija Ana me coment√≥ que hubo un incidente durante la hora del almuerzo donde otro ni√±o le quit√≥ su comida y la maestra no intervino adecuadamente...
            </p>
            <div class="report-details">
              <div>
              <div class="border-t pt-3 mt-3">
                <h4 class="font-medium mb-2">Mensaje completo:</h4>
                <p class="text-sm text-slate-700 mb-3">
                  Mi hija Ana me coment√≥ que hubo un incidente durante la hora del almuerzo donde otro ni√±o le quit√≥ su comida y la maestra no intervino adecuadamente. Ana lleg√≥ a casa muy triste y sin haber comido bien. Necesito que se tome acci√≥n inmediata para resolver esta situaci√≥n y evitar que se repita.
                </p>
                <h4 class="font-medium mb-2">Archivos adjuntos:</h4>
                <div class="flex gap-2 mb-3">
                  <div class="flex items-center gap-2 px-3 py-2 bg-slate-100 rounded">
                    <i data-lucide="image" class="w-4 h-4"></i>
                    <span class="text-sm">foto_almuerzo.jpg</span>
                    <button class="text-blue-600 hover:text-blue-800 text-xs">Ver</button>
                  </div>
                </div>
                <div class="flex gap-2">
                  <button onclick="resolveReport(this)" class="px-3 py-2 bg-green-600 text-white rounded text-sm">Marcar como Resuelto</button>
                  <button onclick="respondReport(this)" class="px-3 py-2 bg-blue-600 text-white rounded text-sm">Responder</button>
                </div>
              </div>
              </div>
            </div>
          </div>

          <!-- Reporte ejemplo 2 -->
          <div class="bg-white rounded shadow p-4 border-l-4 border-yellow-500">
            <div class="flex items-start justify-between mb-3">
              <div>
                <h3 class="font-semibold text-yellow-700">Reporte - Solicitud de material</h3>
                <p class="text-sm text-slate-600">
                  <span class="font-medium">De:</span> Carolina Mart√≠nez (Maestra Aula A1) ‚Ä¢ 
                  <span class="font-medium">Fecha:</span> 14 Dic 2024, 2:15 PM
                </p>
              </div>
              <div class="flex gap-2">
                <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">En proceso</span>
                <button onclick="toggleReportDetails(this)" class="text-blue-600 hover:text-blue-800 text-sm">Ver detalles</button>
              </div>
            </div>
            <p class="text-sm text-slate-700 mb-3">
              Necesito solicitar material adicional para las actividades de arte. Los ni√±os han mostrado mucho inter√©s y necesitamos m√°s suministros...
            </p>
            <div class="report-details">
              <div>
              <div class="border-t pt-3 mt-3">
                <h4 class="font-medium mb-2">Mensaje completo:</h4>
                <p class="text-sm text-slate-700 mb-3">
                  Necesito solicitar material adicional para las actividades de arte. Los ni√±os han mostrado mucho inter√©s y necesitamos m√°s suministros como pintura, pinceles, papel de colores y plastilina. Adjunto la lista detallada y algunas fotos de los trabajos que han realizado.
                </p>
                <h4 class="font-medium mb-2">Archivos adjuntos:</h4>
                <div class="flex gap-2 mb-3">
                  <div class="flex items-center gap-2 px-3 py-2 bg-slate-100 rounded">
                    <i data-lucide="file-text" class="w-4 h-4"></i>
                    <span class="text-sm">lista_materiales.pdf</span>
                    <button class="text-blue-600 hover:text-blue-800 text-xs">Ver</button>
                  </div>
                  <div class="flex items-center gap-2 px-3 py-2 bg-slate-100 rounded">
                    <i data-lucide="image" class="w-4 h-4"></i>
                    <span class="text-sm">trabajos_arte.jpg</span>
                    <button class="text-blue-600 hover:text-blue-800 text-xs">Ver</button>
                  </div>
                </div>
                <div class="flex gap-2">
                  <button onclick="resolveReport(this)" class="px-3 py-2 bg-green-600 text-white rounded text-sm">Marcar como Resuelto</button>
                  <button onclick="respondReport(this)" class="px-3 py-2 bg-blue-600 text-white rounded text-sm">Responder</button>
                </div>
              </div>
              </div>
            </div>
          </div>

          <!-- Reporte ejemplo 3 - Resuelto -->
          <div class="bg-white rounded shadow p-4 border-l-4 border-green-500">
            <div class="flex items-start justify-between mb-3">
              <div>
                <h3 class="font-semibold text-green-700">Queja - Horario de recogida</h3>
                <p class="text-sm text-slate-600">
                  <span class="font-medium">De:</span> Carlos Rodr√≠guez (Padre de Luis Rodr√≠guez) ‚Ä¢ 
                  <span class="font-medium">Fecha:</span> 12 Dic 2024, 4:45 PM
                </p>
              </div>
              <div class="flex gap-2">
                <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">Resuelto</span>
                <button onclick="toggleReportDetails(this)" class="text-blue-600 hover:text-blue-800 text-sm">Ver detalles</button>
              </div>
            </div>
            <p class="text-sm text-slate-700 mb-3">
              Tengo dificultades con el horario de recogida actual. Mi trabajo termina a las 5:30 PM y necesito flexibilidad...
            </p>
            <div class="report-details">
              <div>
              <div class="border-t pt-3 mt-3">
                <h4 class="font-medium mb-2">Mensaje completo:</h4>
                <p class="text-sm text-slate-700 mb-3">
                  Tengo dificultades con el horario de recogida actual. Mi trabajo termina a las 5:30 PM y necesito flexibilidad en el horario. ¬øEs posible extender el horario hasta las 6:00 PM?
                </p>
                <h4 class="font-medium mb-2 text-green-700">Resoluci√≥n:</h4>
                <p class="text-sm text-green-700 mb-3">
                  Se ha aprobado la extensi√≥n del horario hasta las 6:00 PM para casos especiales. Se ha actualizado el registro del estudiante.
                </p>
                <p class="text-xs text-slate-500">Resuelto por: Directora ‚Ä¢ 13 Dic 2024, 9:00 AM</p>
              </div>
            </div>
            </div>
          </div>
        </div>
      </section>

      <!-- PAGOS -->
      <section id="pagos" class="section hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            <i data-lucide="credit-card" class="w-5 h-5 text-slate-600"></i><span>Pagos</span>
          </h2>
          <div class="flex items-center gap-2">
            <input id="searchPayment" placeholder="Buscar alumno..." class="px-3 py-2 border rounded text-sm hidden md:block" onkeyup="filterPayments()">
            <select id="paymentsClassFilter" class="px-3 py-2 border rounded">
              <option value="Peque√±os">Peque√±os</option>
              <option value="Medianos">Medianos</option>
              <option value="Grandes">Grandes</option>
            </select>
            <button id="btnRecordatorioMasivo" class="btn btn-pink">Recordatorio masivo</button>
            <button id="btnNuevoPago" class="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm">Registrar pago</button>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="col-span-2 bg-white rounded shadow p-4">
            <h3 class="font-semibold mb-3">Resumen</h3>
            <div class="flex gap-3">
              <span id="paymentsTotal" class="chip chip-blue">Total: 0</span>
              <span id="paymentsPagados" class="chip chip-green">Pagados: 0</span>
              <span id="paymentsPendientes" class="chip chip-orange">Pendientes: 0</span>
            </div>
            <canvas id="paymentsChart" height="120" class="mt-4"></canvas>
          </div>
          <div class="bg-white rounded shadow p-4">
            <h3 class="font-semibold mb-3">Importe</h3>
            <p id="paymentsAmount" class="text-lg font-semibold">$0.00</p>
            <p class="text-xs text-slate-500">Suma de importes en la clase seleccionada.</p>
          </div>
        </div>
        <div class="mt-6 bg-white rounded shadow p-4">
          <h3 class="font-semibold mb-3">Listado</h3>
          <table class="w-full text-sm">
            <thead class="text-slate-500 text-left">
              <tr><th>Estudiante</th><th>Aula</th><th>Mes</th><th>Monto</th><th>Estado</th><th>Acciones</th></tr>
            </thead>
            <tbody id="paymentsTable"><!-- Llenado din√°micamente por JS --></tbody>
          </table>
        </div>
      </section>

      <!-- COMUNICACION -->
      <section id="comunicacion" class="section hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            <i data-lucide="message-square" class="w-5 h-5 text-slate-600"></i><span>Comunicaciones</span>
          </h2>
          <div>
            <button id="sendAnnouncement" class="px-3 py-2 bg-pink-600 text-white rounded">Enviar anuncio</button>
          </div>
        </div>
        <div class="space-y-4">
          <!-- Anuncio general -->
          <div class="bg-white rounded shadow p-4">
            <h3 class="text-sm font-semibold mb-2">Anuncio general</h3>
            <textarea id="announcementText" class="w-full border rounded p-3" rows="4" placeholder="Escribe un comunicado para todos..."></textarea>
            <div class="mt-3 flex justify-end">
              <button class="px-3 py-2 bg-indigo-600 text-white rounded">Enviar a todos</button>
            </div>
          </div>
          
          <!-- Chat privado -->
          <div class="bg-white rounded shadow p-4">
            <h3 class="text-sm font-semibold mb-2">Mensajes privados</h3>
            <div class="grid md:grid-cols-3 gap-3">
              <div class="md:col-span-1 rounded-3xl bg-white p-3 border">
                <input id="contactFilter" class="w-full border rounded-xl px-2 py-1 text-sm" placeholder="Filtrar contacto" />
                <div id="contactList" class="mt-2 space-y-1 max-h-64 overflow-auto"></div>
              </div>
              <div class="md:col-span-2 rounded-3xl bg-white p-3 border flex flex-col">
                <div id="chatHeader" class="text-sm font-semibold">Chat</div>
                <div id="chatMessages" class="flex-1 mt-2 space-y-2 max-h-64 overflow-auto"></div>
                <div id="typingIndicator" class="text-[11px] text-slate-500"></div>
                <div class="mt-2 flex gap-2 items-center">
                  <button id="chatEmoji" class="px-2 py-1 rounded bg-slate-100">üòÄ</button>
                  <input id="chatInput" class="flex-1 border rounded-xl px-2 py-1 text-sm" placeholder="Escribe un mensaje" />
                  <button id="chatSend" class="text-sm px-3 py-2 rounded-xl bg-karpus-pink text-white">Enviar</button>
                </div>
                <div id="emojiMenu" class="hidden border rounded p-2"></div>
              </div>
            </div>
          </div>
          
          <!-- Notificaciones -->
          <div class="bg-white rounded shadow p-4">
            <h3 class="text-sm font-semibold mb-2">Notificaciones programadas</h3>
            <div class="space-y-2">
              <div class="flex gap-3">
                <input type="datetime-local" class="border rounded px-3 py-2 flex-1">
                <select class="border rounded px-3 py-2">
                  <option value="all">Todos</option>
                  <option value="teachers">Maestros</option>
                  <option value="parents">Padres</option>
                </select>
              </div>
              <textarea class="w-full border rounded p-3" rows="2" placeholder="Texto de la notificaci√≥n..."></textarea>
              <div class="flex justify-end">
                <button class="px-3 py-2 bg-green-600 text-white rounded">Programar</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- CONFIGURACI√ìN -->
      <section id="configuracion" class="section hidden">
        <div class="flex items-center gap-3 mb-6">
          <i data-lucide="settings" class="w-7 h-7 text-slate-600"></i>
          <h2 class="text-2xl font-bold">Configuraci√≥n y Perfil</h2>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Perfil Directora -->
          <div class="lg:col-span-2 space-y-6">
            <div class="bg-white rounded shadow p-6">
              <h3 class="text-lg font-semibold mb-4 border-b pb-2 flex items-center gap-2"><i data-lucide="user-circle" class="w-5 h-5"></i> Perfil Profesional (Directora)</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">Nombre Completo</label>
                  <input id="confDirName" type="text" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-purple-500 outline-none" value="Karonlyn Garc√≠a">
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">T√≠tulo / Cargo</label>
                  <input id="confDirTitle" type="text" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-purple-500 outline-none" value="Directora General">
                </div>
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium text-slate-700 mb-1">Presentaci√≥n / Biograf√≠a</label>
                  <textarea id="confDirBio" rows="4" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Escribe una breve presentaci√≥n...">Fundadora y CEO, apasionada por la educaci√≥n y el bienestar infantil. Con una visi√≥n clara y un coraz√≥n dedicado...</textarea>
                  <p class="text-xs text-slate-500 mt-1">Esta informaci√≥n ser√° visible en el perfil p√∫blico para padres y maestros.</p>
                </div>
              </div>
            </div>

            <div class="bg-white rounded shadow p-6">
              <h3 class="text-lg font-semibold mb-4 border-b pb-2 flex items-center gap-2"><i data-lucide="building" class="w-5 h-5"></i> Informaci√≥n Institucional</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">Tel√©fono Institucional</label>
                  <input id="confPhone" type="tel" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-purple-500 outline-none" value="+1 (829) 803-8424">
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">Correo de Contacto</label>
                  <input id="confEmail" type="email" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-purple-500 outline-none" value="info@karpuskids.com">
                </div>
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium text-slate-700 mb-1">Direcci√≥n F√≠sica</label>
                  <input id="confAddress" type="text" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-purple-500 outline-none" value="Calle Principal #123, Santo Domingo">
                </div>
              </div>
            </div>
          </div>

          <!-- Avatar y Acciones -->
          <div class="space-y-6">
            <div class="bg-white rounded shadow p-6 text-center">
              <h3 class="text-sm font-semibold mb-4">Foto de Perfil</h3>
              <div class="relative w-32 h-32 mx-auto mb-4 group">
                <img src="img/mundo.jpg" alt="Avatar" class="w-full h-full object-cover rounded-full border-4 border-slate-100 shadow-sm group-hover:opacity-90 transition-opacity">
                <button class="absolute bottom-0 right-0 bg-purple-600 text-white p-2 rounded-full shadow hover:bg-purple-700 transition-colors" title="Cambiar foto">
                  <i data-lucide="camera" class="w-4 h-4"></i>
                </button>
              </div>
              <p class="text-xs text-slate-500 mb-4">JPG, PNG o WEBP. M√°x 2MB.</p>
            </div>

            <div class="bg-white rounded shadow p-6">
              <h3 class="text-sm font-semibold mb-4">Acciones</h3>
              <button onclick="alert('Configuraci√≥n guardada exitosamente')" class="w-full py-2 bg-green-600 text-white rounded hover:bg-green-700 mb-3 flex items-center justify-center gap-2 transition-colors">
                <i data-lucide="save" class="w-4 h-4"></i> Guardar Cambios
              </button>
              <button class="w-full py-2 border border-slate-300 text-slate-700 rounded hover:bg-slate-50 transition-colors">Cancelar</button>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- MODAL: Crear/Editar Maestro -->
  <div id="teacherModal" class="fixed inset-0 bg-black/40 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
      <h3 class="font-semibold mb-3 flex items-center gap-2">
        <i data-lucide="user-cog" class="w-5 h-5"></i>
        <span id="teacherModalTitle">Crear Maestro</span>
      </h3>
      <input type="hidden" id="tmId">
      <div class="grid gap-3">
        <div>
          <label class="text-sm text-slate-600 block mb-1">Nombre completo</label>
          <input id="tmName" placeholder="Ej: Mar√≠a Gonz√°lez" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="text-sm text-slate-600 block mb-1">Tel√©fono</label>
          <input id="tmPhone" type="tel" placeholder="Ej: +57 300 123 4567" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="text-sm text-slate-600 block mb-1">Correo electr√≥nico</label>
          <input id="tmEmail" type="email" placeholder="Ej: maria@karpus.com" class="w-full border rounded px-3 py-2" />
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-slate-600 block mb-1">Usuario</label>
            <input id="tmUsername" placeholder="Ej: maria.g" class="w-full border rounded px-3 py-2" />
          </div>
          <div>
            <label class="text-sm text-slate-600 block mb-1">Especialidad</label>
            <input id="tmSpecialty" placeholder="Ej: Ingl√©s" class="w-full border rounded px-3 py-2" />
          </div>
        </div>
        <div>
          <label class="text-sm text-slate-600 block mb-1">Contrase√±a</label>
          <input id="tmPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="text-sm text-slate-600 block mb-1">Estado</label>
          <select id="tmStatus" class="w-full border rounded px-3 py-2">
            <option value="Activo">Activo</option>
            <option value="Inactivo">Inactivo</option>
          </select>
        </div>
        <div class="flex justify-end gap-2 mt-3">
          <button onclick="document.getElementById('teacherModal').classList.add('hidden')" class="px-4 py-2 border rounded-lg hover:bg-slate-50">Cancelar</button>
          <button onclick="saveTeacher()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Ver Estudiantes de Aula -->
  <div id="roomStudentsModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-semibold flex items-center gap-2">
          <i data-lucide="users" class="w-5 h-5 text-slate-600"></i>
          <span id="roomStudentsTitle">Estudiantes</span>
        </h3>
        <button onclick="document.getElementById('roomStudentsModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <div id="roomStudentsList" class="space-y-2 max-h-80 overflow-y-auto">
        <!-- Lista din√°mica -->
      </div>
      <div class="flex justify-end mt-4">
        <button onclick="document.getElementById('roomStudentsModal').classList.add('hidden')" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- MODAL: Crear/Editar Aula -->
  <div id="roomModal" class="fixed inset-0 bg-black/40 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-lg">
      <h3 class="font-semibold mb-3 flex items-center gap-2">
        <i data-lucide="home" class="w-5 h-5"></i>
        <span id="roomModalTitle">Gestionar Aula</span>
      </h3>
      <input type="hidden" id="roomId">
      <div class="grid gap-3">
        <div>
          <label class="text-sm text-slate-600 block mb-1">Nombre del Aula</label>
          <input id="roomName" placeholder="Ej: Aula Peque√±os A1" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="text-sm text-slate-600 block mb-1">Maestro Asignado</label>
          <select id="roomTeacher" class="w-full border rounded px-3 py-2">
            <option value="">Seleccionar maestro...</option>
            <option value="Carolina Mart√≠nez">Carolina Mart√≠nez</option>
            <option value="Andr√©s P√©rez">Andr√©s P√©rez</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-slate-600 block mb-1">Capacidad M√°xima</label>
          <input id="roomCapacity" type="number" min="1" max="30" placeholder="Ej: 15" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="text-sm text-slate-600 block mb-1">Estudiantes Asignados</label>
          <div class="border rounded px-3 py-2 max-h-40 overflow-y-auto bg-slate-50">
            <div id="roomStudentsChecklist" class="space-y-1 p-1">
              <!-- Lista din√°mica de estudiantes con checkboxes -->
            </div>
          </div>
          <p class="text-xs text-slate-500 mt-1">Selecciona los estudiantes que pertenecer√°n a esta aula</p>
        </div>
        <div class="flex justify-end gap-2 mt-3">
          <button onclick="document.getElementById('roomModal').classList.add('hidden')" class="px-4 py-2 border rounded-lg hover:bg-slate-50">Cancelar</button>
          <button onclick="saveRoom()" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Perfil del Estudiante -->
  <div id="studentProfileModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-semibold text-slate-800">Perfil del Estudiante</h3>
          <button id="closeStudentProfileModal" class="text-slate-400 hover:text-slate-600">
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
        </div>
        
        <!-- Informaci√≥n del Estudiante -->
        <div class="mb-6">
          <div class="flex items-center gap-4 mb-4">
            <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center">
              <i data-lucide="user" class="w-8 h-8 text-indigo-600"></i>
            </div>
            <div>
              <h4 id="studentProfileName" class="text-lg font-semibold text-slate-800">Nombre del Estudiante</h4>
              <p class="text-sm text-slate-600">Estudiante activo</p>
            </div>
          </div>
        </div>

        <!-- Datos de los Padres -->
        <div class="space-y-6">
          <div>
            <h5 class="text-lg font-medium text-slate-800 mb-4 flex items-center gap-2">
              <i data-lucide="users" class="w-5 h-5 text-slate-600"></i>
              Informaci√≥n de los Padres
            </h5>
            
            <!-- Padre/Madre 1 -->
            <div class="bg-slate-50 rounded-lg p-4 mb-4">
              <h6 class="font-medium text-slate-700 mb-3">Padre/Madre Principal</h6>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="text-sm text-slate-600 block mb-1">Nombre Completo</label>
                  <p id="parent1Name" class="text-sm font-medium text-slate-800">Ana Mar√≠a P√©rez Gonz√°lez</p>
                </div>
                <div>
                  <label class="text-sm text-slate-600 block mb-1">Tel√©fono</label>
                  <p id="parent1Phone" class="text-sm font-medium text-slate-800">+57 300 123 4567</p>
                </div>
                <div>
                  <label class="text-sm text-slate-600 block mb-1">Correo Electr√≥nico</label>
                  <p id="parent1Email" class="text-sm font-medium text-slate-800">ana.perez@email.com</p>
                </div>
                <div>
                  <label class="text-sm text-slate-600 block mb-1">Ocupaci√≥n</label>
                  <p id="parent1Job" class="text-sm font-medium text-slate-800">Ingeniera de Sistemas</p>
                </div>
                <div>
                  <label class="text-sm text-slate-600 block mb-1">Direcci√≥n</label>
                  <p id="parent1Address" class="text-sm font-medium text-slate-800">Calle 123 #45-67, Bogot√°</p>
                </div>
                <div>
                  <label class="text-sm text-slate-600 block mb-1">Contacto de Emergencia</label>
                  <p id="parent1Emergency" class="text-sm font-medium text-slate-800">+57 301 987 6543</p>
                </div>
              </div>
            </div>

            <!-- Padre/Madre 2 -->
            <div class="bg-slate-50 rounded-lg p-4">
              <h6 class="font-medium text-slate-700 mb-3">Padre/Madre Secundario</h6>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="text-sm text-slate-600 block mb-1">Nombre Completo</label>
                  <p id="parent2Name" class="text-sm font-medium text-slate-800">Carlos Eduardo P√©rez</p>
                </div>
                <div>
                  <label class="text-sm text-slate-600 block mb-1">Tel√©fono</label>
                  <p id="parent2Phone" class="text-sm font-medium text-slate-800">+57 310 456 7890</p>
                </div>
                <div>
                  <label class="text-sm text-slate-600 block mb-1">Correo Electr√≥nico</label>
                  <p id="parent2Email" class="text-sm font-medium text-slate-800">carlos.perez@email.com</p>
                </div>
                <div>
                  <label class="text-sm text-slate-600 block mb-1">Ocupaci√≥n</label>
                  <p id="parent2Job" class="text-sm font-medium text-slate-800">Contador P√∫blico</p>
                </div>
                <div>
                  <label class="text-sm text-slate-600 block mb-1">Direcci√≥n</label>
                  <p id="parent2Address" class="text-sm font-medium text-slate-800">Calle 123 #45-67, Bogot√°</p>
                </div>
                <div>
                  <label class="text-sm text-slate-600 block mb-1">Contacto de Emergencia</label>
                  <p id="parent2Emergency" class="text-sm font-medium text-slate-800">+57 320 111 2233</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Informaci√≥n Adicional -->
          <div class="bg-blue-50 rounded-lg p-4">
            <h6 class="font-medium text-blue-800 mb-3 flex items-center gap-2">
              <i data-lucide="info" class="w-4 h-4"></i>
              Informaci√≥n Adicional
            </h6>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="text-sm text-blue-700 block mb-1">Aula Asignada</label>
                <p id="studentRoom" class="text-sm font-medium text-blue-800">Aula Peque√±os A1</p>
              </div>
              <div>
                <label class="text-sm text-blue-700 block mb-1">Fecha de Ingreso</label>
                <p id="studentStartDate" class="text-sm font-medium text-blue-800">15 de Febrero, 2024</p>
              </div>
              <div>
                <label class="text-sm text-blue-700 block mb-1">Alergias/Condiciones</label>
                <p id="studentAllergies" class="text-sm font-medium text-blue-800">Ninguna conocida</p>
              </div>
              <div>
                <label class="text-sm text-blue-700 block mb-1">Autorizado para Recoger</label>
                <p id="studentPickup" class="text-sm font-medium text-blue-800">Padres y Abuela Materna</p>
              </div>
              <div>
                <label class="text-sm text-blue-700 block mb-1">Tipo de Sangre</label>
                <p id="studentBlood" class="text-sm font-medium text-blue-800">O+</p>
              </div>
            </div>
          </div>
        </div>

        <div class="flex justify-end gap-2 mt-6">
          <button id="editStudentProfile" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
            Editar Informaci√≥n
          </button>
          <button id="closeStudentProfile" class="px-4 py-2 border rounded-lg hover:bg-slate-50">
            Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Agregar Estudiante (Director) -->
  <div id="modalAddStudent" class="fixed inset-0 bg-black/40 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-lg">
      <h3 class="font-semibold mb-3 flex items-center gap-2">
        <i data-lucide="user-plus" class="w-5 h-5"></i>
        Agregar Estudiante
      </h3>
      <div class="grid gap-3">
        <div>
          <label class="text-sm text-slate-600 block mb-1">Nombre del ni√±o</label>
          <input id="stName" placeholder="Ej: Juan P√©rez" class="w-full border rounded px-3 py-2" />
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-sm text-slate-600 block mb-1">Edad</label>
            <input id="stAge" type="number" min="0" placeholder="Edad" class="w-full border rounded px-3 py-2" />
          </div>
          <div>
            <label class="text-sm text-slate-600 block mb-1">Horario</label>
            <input id="stSchedule" placeholder="08:00-12:00" class="w-full border rounded px-3 py-2" />
          </div>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <input id="p1Name" placeholder="Padre/Madre 1 (nombre)" class="border rounded px-3 py-2" />
          <input id="p1Phone" placeholder="Tel√©fono 1" class="border rounded px-3 py-2" />
        </div>
        <div class="grid grid-cols-2 gap-2">
          <input id="p2Name" placeholder="Padre/Madre 2 (nombre)" class="border rounded px-3 py-2" />
          <input id="p2Phone" placeholder="Tel√©fono 2" class="border rounded px-3 py-2" />
        </div>
        <div class="grid grid-cols-2 gap-2">
          <input id="stAllergies" placeholder="Alergias" class="border rounded px-3 py-2" />
          <input id="stBlood" placeholder="Tipo de Sangre" class="border rounded px-3 py-2" />
        </div>
        <div>
          <label class="text-sm text-slate-600 block mb-1">Personas autorizadas para recoger</label>
          <input id="stPickup" placeholder="Ej: Abuela Carmen, T√≠o Juan" class="w-full border rounded px-3 py-2" />
        </div>
        <label class="flex items-center gap-2"><input id="stActive" type="checkbox" checked class="rounded" /> Estudiante activo</label>
        <div class="flex justify-end gap-2 mt-3">
          <button onclick="document.getElementById('modalAddStudent').classList.add('hidden')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button onclick="saveStudent()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  
  <script src="js/store.js?v=2"></script>
  <script src="js/common_ui.js"></script>
  <script>
    // L√≥gica para la gr√°fica de asistencia
    let attendanceChartInstance = null;

    function initChart() {
      const ctx = document.getElementById('attendanceChart').getContext('2d');
      
      // Datos iniciales (D√≠a)
      const dataDay = {
        labels: ['8:00', '9:00', '10:00', '11:00', '12:00', '13:00'],
        datasets: [{
          label: 'Asistencia Hoy',
          data: [15, 20, 24, 24, 22, 18],
          borderColor: '#4f46e5',
          backgroundColor: 'rgba(79, 70, 229, 0.1)',
          fill: true,
          tension: 0.4
        }]
      };

      attendanceChartInstance = new Chart(ctx, {
        type: 'line',
        data: dataDay,
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    function updateChart(period) {
      if (!attendanceChartInstance) return;
      
      // Actualizar estilos de botones
      // (Simplificado: en una implementaci√≥n real, cambiar clases activas)

      if (period === 'day') {
        attendanceChartInstance.data.labels = ['8:00', '9:00', '10:00', '11:00', '12:00', '13:00'];
        attendanceChartInstance.data.datasets[0].data = [15, 20, 24, 24, 22, 18];
        attendanceChartInstance.data.datasets[0].label = 'Asistencia Hoy';
      } else if (period === 'week') {
        attendanceChartInstance.data.labels = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie'];
        attendanceChartInstance.data.datasets[0].data = [22, 24, 21, 25, 23];
        attendanceChartInstance.data.datasets[0].label = 'Asistencia Semana';
      } else if (period === 'month') {
        attendanceChartInstance.data.labels = ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'];
        attendanceChartInstance.data.datasets[0].data = [95, 92, 98, 94]; // Promedios o totales
        attendanceChartInstance.data.datasets[0].label = 'Asistencia Mes';
      }
      attendanceChartInstance.update();
    }

    // Toggle detalles de reportes con animaci√≥n
    window.toggleReportDetails = function(btn) {
      const card = btn.closest('.bg-white');
      const details = card.querySelector('.report-details');
      if (details) {
        details.classList.toggle('open');
        btn.textContent = details.classList.contains('open') ? 'Ocultar detalles' : 'Ver detalles';
      }
    };

    // L√≥gica de navegaci√≥n del sidebar
    function initNavigation() {
      const navBtns = document.querySelectorAll('.nav-btn');
      const sections = document.querySelectorAll('.section');

      navBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const sectionId = btn.getAttribute('data-section');
          
          // Remover clase activa de todos
          navBtns.forEach(b => b.classList.remove('bg-white/20'));
          // Agregar clase activa al clickeado
          btn.classList.add('bg-white/20');

          // Ocultar todas las secciones
          sections.forEach(sec => sec.classList.add('hidden'));
          
          // Mostrar la secci√≥n seleccionada
          const target = document.getElementById(sectionId);
          if (target) {
            target.classList.remove('hidden');
          }
        });
      });
    }

    // Variable global para la instancia de la gr√°fica de pagos
    let paymentsChartInstance = null;

    // Gr√°fica de Pagos (Pie Chart)
    function initPaymentsChart() {
      const ctx = document.getElementById('paymentsChart');
      if (!ctx) return;

      paymentsChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Pagados', 'Pendientes'],
          datasets: [{
            data: [0, 0], // Se actualizar√° din√°micamente
            backgroundColor: ['#10b981', '#f59e0b'], // Verde, Naranja
            borderWidth: 0,
            hoverOffset: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { usePointStyle: true, boxWidth: 8 }
            }
          },
          cutout: '70%'
        }
      });
    }

    // Base de datos simulada de estudiantes para el perfil
    const studentsDb = {
      'Mar√≠a Fernanda P√©rez': {
        room: 'Aula Peque√±os A1',
        start: '15 Feb 2024',
        allergies: 'Man√≠ (Severa)',
        pickup: 'Padres y Abuela Carmen',
        blood: 'O+',
        p1: { name: 'Ana P√©rez', phone: '+1 829-555-0101', email: 'ana@email.com', job: 'Arquitecta', address: 'Calle 1 #23' },
        p2: { name: 'Juan P√©rez', phone: '+1 829-555-0102', email: 'juan@email.com', job: 'Ingeniero', address: 'Calle 1 #23' }
      },
      'Javier Alejandro Rodr√≠guez': {
        room: 'Aula Medianos B1',
        start: '10 Mar 2024',
        allergies: 'Ninguna',
        pickup: 'Solo Padres',
        blood: 'A+',
        p1: { name: 'Luisa Rodr√≠guez', phone: '+1 829-555-0201', email: 'luisa@email.com', job: 'Doctora', address: 'Av. Principal #45' },
        p2: { name: 'Pedro Rodr√≠guez', phone: '+1 829-555-0202', email: 'pedro@email.com', job: 'Abogado', address: 'Av. Principal #45' }
      },
      'Ana Sof√≠a Gonz√°lez': {
        room: 'Aula Peque√±os A1',
        start: '01 Abr 2024',
        allergies: 'Polvo',
        pickup: 'Padres y T√≠a Rosa',
        blood: 'B+',
        p1: { name: 'Marta Gonz√°lez', phone: '+1 829-555-0301', email: 'marta@email.com', job: 'Dise√±adora', address: 'Res. Las Palmas' },
        p2: { name: 'Luis Gonz√°lez', phone: '+1 829-555-0302', email: 'luis@email.com', job: 'Comerciante', address: 'Res. Las Palmas' }
      },
      'Carlos Eduardo Mart√≠nez': {
        room: 'Aula Grandes C1',
        start: '20 Ene 2024',
        allergies: 'Lactosa',
        pickup: 'Padres',
        blood: 'O-',
        p1: { name: 'Elena Mart√≠nez', phone: '+1 829-555-0401', email: 'elena@email.com', job: 'Contadora', address: 'Calle Sol #8' },
        p2: { name: 'Mario Mart√≠nez', phone: '+1 829-555-0402', email: 'mario@email.com', job: 'Profesor', address: 'Calle Sol #8' }
      }
    };

    // Funci√≥n para ver perfil de estudiante con datos reales
    window.viewStudentProfile = function(btn) {
      // Intentar obtener el nombre desde la fila
      const row = btn.closest('tr');
      const nameEl = row.querySelector('.font-medium');
      const name = nameEl ? nameEl.textContent.trim() : 'Mar√≠a Fernanda P√©rez'; // Fallback
      
      const data = studentsDb[name] || studentsDb['Mar√≠a Fernanda P√©rez']; // Fallback a datos demo si no existe

      // Llenar modal
      document.getElementById('studentProfileName').textContent = name;
      document.getElementById('studentRoom').textContent = data.room;
      document.getElementById('studentStartDate').textContent = data.start;
      document.getElementById('studentAllergies').textContent = data.allergies;
      document.getElementById('studentPickup').textContent = data.pickup;
      document.getElementById('studentBlood').textContent = data.blood;

      // Padres
      document.getElementById('parent1Name').textContent = data.p1.name;
      document.getElementById('parent1Phone').textContent = data.p1.phone;
      document.getElementById('parent1Email').textContent = data.p1.email;
      document.getElementById('parent1Job').textContent = data.p1.job;
      document.getElementById('parent1Address').textContent = data.p1.address;
      
      document.getElementById('parent2Name').textContent = data.p2.name;
      document.getElementById('parent2Phone').textContent = data.p2.phone;
      document.getElementById('parent2Email').textContent = data.p2.email;
      document.getElementById('parent2Job').textContent = data.p2.job;
      document.getElementById('parent2Address').textContent = data.p2.address;

      // Mostrar modal
      document.getElementById('studentProfileModal').classList.remove('hidden');
    };

    // Cerrar modal perfil
    document.getElementById('closeStudentProfileModal').addEventListener('click', () => {
      document.getElementById('studentProfileModal').classList.add('hidden');
    });
    document.getElementById('closeStudentProfile').addEventListener('click', () => {
      document.getElementById('studentProfileModal').classList.add('hidden');
    });

    // Funci√≥n para marcar todos presente
    window.markAllPresent = function() {
      const selects = document.querySelectorAll('.attendance-select');
      selects.forEach(sel => sel.value = 'Presente');
      alert('Se han marcado todos los estudiantes como "Presente". Recuerde guardar los cambios si es necesario.');
    };

    // Filtrar pagos
    window.filterPayments = function() {
      const input = document.getElementById('searchPayment');
      const filter = input.value.toUpperCase();
      const table = document.getElementById('paymentsTable');
      const tr = table.getElementsByTagName('tr');

      for (let i = 0; i < tr.length; i++) {
        const td = tr[i].getElementsByTagName('td')[0];
        if (td) {
          const txtValue = td.textContent || td.innerText;
          if (txtValue.toUpperCase().indexOf(filter) > -1) {
            tr.style.display = "";
          } else {
            tr.style.display = "none";
          }
        }       
      }
    };

    // Datos simulados de pagos
    const paymentsData = [
      { id: 1, student: 'Mar√≠a Fernanda P√©rez', room: 'Peque√±os', month: 'Noviembre', amount: 3800, status: 'Pagado' },
      { id: 2, student: 'Javier Rodr√≠guez', room: 'Medianos', month: 'Noviembre', amount: 3800, status: 'Pendiente' },
      { id: 3, student: 'Ana Sof√≠a Gonz√°lez', room: 'Peque√±os', month: 'Noviembre', amount: 5400, status: 'Pagado' },
      { id: 4, student: 'Carlos Mart√≠nez', room: 'Grandes', month: 'Noviembre', amount: 3800, status: 'Pendiente' },
      { id: 5, student: 'Luc√≠a M√©ndez', room: 'Medianos', month: 'Octubre', amount: 3800, status: 'Vencido' },
      { id: 6, student: 'Pedro Alc√°ntara', room: 'Grandes', month: 'Noviembre', amount: 5400, status: 'Pagado' },
    ];

    // Renderizar tabla de pagos y actualizar estad√≠sticas
    function renderPaymentsTable() {
      const tbody = document.getElementById('paymentsTable');
      if(!tbody) return;
      tbody.innerHTML = '';
      
      let total = 0;
      let paid = 0;
      let pending = 0;
      let amountSum = 0;

      paymentsData.forEach(p => {
        total++;
        if(p.status === 'Pagado') paid++;
        else pending++;
        amountSum += p.amount;

        const tr = document.createElement('tr');
        tr.className = 'hover:bg-slate-50 border-b border-slate-100';
        
        let statusClass = '';
        if(p.status === 'Pagado') statusClass = 'bg-green-100 text-green-800';
        else if(p.status === 'Pendiente') statusClass = 'bg-orange-100 text-orange-800';
        else statusClass = 'bg-red-100 text-red-800';

        tr.innerHTML = `
          <td class="py-3 px-2 font-medium">${p.student}</td>
          <td class="py-3 px-2 text-slate-500">${p.room}</td>
          <td class="py-3 px-2">${p.month}</td>
          <td class="py-3 px-2 font-mono">RD$ ${p.amount.toLocaleString()}</td>
          <td class="py-3 px-2"><span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${p.status}</span></td>
          <td class="py-3 px-2">
            <button class="text-slate-400 hover:text-blue-600" title="Ver recibo"><i data-lucide="file-text" class="w-4 h-4"></i></button>
            ${p.status !== 'Pagado' ? '<button class="text-slate-400 hover:text-green-600 ml-2" title="Registrar pago"><i data-lucide="dollar-sign" class="w-4 h-4"></i></button>' : ''}
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Actualizar contadores
      document.getElementById('paymentsTotal').textContent = `Total: ${total}`;
      document.getElementById('paymentsPagados').textContent = `Pagados: ${paid}`;
      document.getElementById('paymentsPendientes').textContent = `Pendientes: ${pending}`;
      document.getElementById('paymentsAmount').textContent = `RD$ ${amountSum.toLocaleString()}`;
      
      // Actualizar Gr√°fica
      if(paymentsChartInstance) {
         paymentsChartInstance.data.datasets[0].data = [paid, pending];
         paymentsChartInstance.update();
      }
    }

    // Funci√≥n para exportar datos del Dashboard
    window.exportDashboardData = function() {
      const data = [
        ['M√©trica', 'Valor'],
        ['Ni√±os Presentes', document.getElementById('ninosPresentes').innerText],
        ['Maestros Activos', document.getElementById('maestrosActivos').innerText],
        ['Solicitudes', document.getElementById('solicitudesHoy').innerText]
      ];
      let csvContent = "data:text/csv;charset=utf-8," + data.map(e => e.join(",")).join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "resumen_dashboard.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    // --- L√ìGICA DE MAESTROS (Mejorada) ---
    let teachersData = [
      { id: 1, name: 'Carolina Mart√≠nez', email: 'carolina@karpus.com', phone: '+57 300 123 4567', username: 'carolina.m', specialty: 'Preescolar', status: 'Activo' },
      { id: 2, name: 'Andr√©s P√©rez', email: 'andres@karpus.com', phone: '+57 301 987 6543', username: 'andres.p', specialty: 'Ingl√©s', status: 'Inactivo' }
    ];

    function renderTeachers() {
      const tbody = document.getElementById('teachersTable');
      if(!tbody) return;
      tbody.innerHTML = '';
      teachersData.forEach(t => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-100 hover:bg-slate-50';
        tr.innerHTML = `
          <td class="py-3 px-2 font-medium">${t.name}</td>
          <td class="py-3 px-2 text-slate-500">${t.email}</td>
          <td class="py-3 px-2 text-slate-500">${t.phone}</td>
          <td class="py-3 px-2"><span class="px-2 py-1 ${t.status === 'Activo' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'} rounded-full text-xs">${t.status}</span></td>
          <td class="py-3 px-2">
            <button class="text-blue-600 hover:text-blue-800 mr-2" onclick="editTeacher(${t.id})">Editar</button>
            <button class="text-red-600 hover:text-red-800" onclick="deleteTeacher(${t.id})">Eliminar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      if(window.lucide) lucide.createIcons();
    }

    window.openTeacherModal = function() {
      document.getElementById('tmId').value = '';
      document.getElementById('tmName').value = '';
      document.getElementById('tmPhone').value = '';
      document.getElementById('tmEmail').value = '';
      document.getElementById('tmUsername').value = '';
      document.getElementById('tmSpecialty').value = '';
      document.getElementById('tmPassword').value = '';
      document.getElementById('teacherModalTitle').innerText = 'Crear Maestro';
      document.getElementById('teacherModal').classList.remove('hidden');
    };

    window.editTeacher = function(id) {
      const t = teachersData.find(x => x.id === id);
      if(!t) return;
      document.getElementById('tmId').value = t.id;
      document.getElementById('tmName').value = t.name;
      document.getElementById('tmPhone').value = t.phone;
      document.getElementById('tmEmail').value = t.email;
      document.getElementById('tmUsername').value = t.username || '';
      document.getElementById('tmSpecialty').value = t.specialty || '';
      document.getElementById('tmPassword').value = ''; // No mostrar contrase√±a por seguridad
      document.getElementById('tmStatus').value = t.status;
      
      document.getElementById('teacherModalTitle').innerText = 'Editar Maestro';
      document.getElementById('teacherModal').classList.remove('hidden');
    };

    window.deleteTeacher = function(id) {
      if(confirm('¬øEst√° seguro de eliminar este maestro?')) {
        teachersData = teachersData.filter(x => x.id !== id);
        renderTeachers();
      }
    };

    window.saveTeacher = function() {
      const id = document.getElementById('tmId').value;
      const name = document.getElementById('tmName').value;
      const email = document.getElementById('tmEmail').value;
      const password = document.getElementById('tmPassword').value;
      
      if(!name || !email) { alert('Nombre y correo son obligatorios'); return; }
      if(!id && !password) { alert('La contrase√±a es obligatoria para nuevos maestros'); return; }

      const newData = {
        id: id ? parseInt(id) : Date.now(),
        name: name,
        email: email,
        phone: document.getElementById('tmPhone').value,
        username: document.getElementById('tmUsername').value,
        specialty: document.getElementById('tmSpecialty').value,
        status: document.getElementById('tmStatus').value
      };

      if(id) {
        const idx = teachersData.findIndex(x => x.id == id);
        if(idx >= 0) teachersData[idx] = newData;
      } else {
        teachersData.push(newData);
        
        // --- L√ìGICA DE LOGIN (Simulaci√≥n) ---
        // Guardamos el usuario en localStorage para que pueda "iniciar sesi√≥n"
        // Esto asume que tu sistema de login lee de 'karpus_users' o similar.
        try {
          const users = JSON.parse(localStorage.getItem('karpus_users') || '[]');
          users.push({
            email: email,
            password: password,
            role: 'maestra',
            name: name
          });
          localStorage.setItem('karpus_users', JSON.stringify(users));
        } catch(e) { console.error('Error guardando usuario local', e); }
      }
      
      renderTeachers();
      document.getElementById('teacherModal').classList.add('hidden');
      
      // Limpiar formulario
      document.getElementById('tmId').value = '';
      ['tmName','tmPhone','tmEmail','tmUsername','tmSpecialty'].forEach(i => document.getElementById(i).value = '');
      document.getElementById('teacherModalTitle').innerText = 'Crear Maestro';
    };

    // --- L√ìGICA DE AULAS (Ver Estudiantes) ---
    window.viewRoomStudents = function(btn) {
      const row = btn.closest('tr');
      const roomName = row.querySelector('.font-medium').innerText;
      
      // Filtrar estudiantes de la base de datos simulada (studentsDb)
      // Buscamos coincidencias aproximadas en el nombre del aula
      const studentsInRoom = Object.entries(studentsDb)
        .filter(([name, data]) => {
          // L√≥gica simple: si el nombre del aula contiene "Peque√±os" y el dato tambi√©n, o coincidencia exacta
          return data.room === roomName || (roomName.includes('Peque√±os') && data.room.includes('Peque√±os')) || (roomName.includes('Medianos') && data.room.includes('Medianos'));
        })
        .map(([name, data]) => ({ name, ...data }));

      const list = document.getElementById('roomStudentsList');
      list.innerHTML = '';
      
      if(studentsInRoom.length === 0) {
        list.innerHTML = '<div class="text-center py-4 text-slate-500">No hay estudiantes registrados en esta aula.</div>';
      } else {
        studentsInRoom.forEach(s => {
          const div = document.createElement('div');
          div.className = 'flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-100';
          div.innerHTML = `
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-slate-500 shadow-sm"><i data-lucide="user" class="w-4 h-4"></i></div>
              <div>
                <p class="text-sm font-medium text-slate-800">${s.name}</p>
                <p class="text-xs text-slate-500">Recoge: ${s.pickup}</p>
              </div>
            </div>
            <button onclick="document.getElementById('roomStudentsModal').classList.add('hidden'); viewStudentProfile(this)" class="text-xs text-blue-600 hover:underline font-medium">Ver Perfil</button>
          `;
          list.appendChild(div);
        });
      }
      
      document.getElementById('roomStudentsTitle').innerText = `Estudiantes - ${roomName}`;
      document.getElementById('roomStudentsModal').classList.remove('hidden');
      if(window.lucide) lucide.createIcons();
    };

    // --- L√ìGICA DE CALIFICACIONES ---
    const gradesData = [
      { student: 'Mar√≠a Fernanda P√©rez', room: 'Peque√±os', math: 95, lang: 92, art: 98 },
      { student: 'Javier Rodr√≠guez', room: 'Medianos', math: 88, lang: 85, art: 90 },
      { student: 'Ana Sof√≠a Gonz√°lez', room: 'Peque√±os', math: 98, lang: 96, art: 100 },
      { student: 'Carlos Mart√≠nez', room: 'Grandes', math: 75, lang: 80, art: 85 },
      { student: 'Luc√≠a M√©ndez', room: 'Medianos', math: 90, lang: 92, art: 88 },
      { student: 'Pedro Alc√°ntara', room: 'Grandes', math: 82, lang: 78, art: 95 }
    ];

    window.renderGrades = function() {
      const filter = document.getElementById('gradesFilter').value;
      const tbody = document.getElementById('gradesTable');
      if(!tbody) return;
      tbody.innerHTML = '';

      const filtered = filter === 'all' ? gradesData : gradesData.filter(g => g.room.includes(filter));

      filtered.forEach(g => {
        const avg = Math.round((g.math + g.lang + g.art) / 3);
        let statusColor = 'text-green-600';
        if(avg < 70) statusColor = 'text-red-600';
        else if(avg < 85) statusColor = 'text-yellow-600';

        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-100 hover:bg-slate-50';
        tr.innerHTML = `
          <td class="p-3 font-medium">${g.student}</td>
          <td class="p-3 text-slate-500">${g.room}</td>
          <td class="p-3">${g.math}</td>
          <td class="p-3">${g.lang}</td>
          <td class="p-3">${g.art}</td>
          <td class="p-3 font-bold ${statusColor}">${avg}</td>
          <td class="p-3"><span class="px-2 py-1 rounded-full text-xs ${avg >= 70 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${avg >= 70 ? 'Aprobado' : 'Reprobado'}</span></td>
        `;
        tbody.appendChild(tr);
      });
    };

    // --- SISTEMA DE ALERTAS Y NOTIFICACIONES ---
    const attendanceHistory = [
      { name: 'Carlos Ruiz', absences: 4 }, // Alerta
      { name: 'Ana L√≥pez', absences: 1 },
      { name: 'Javier Rodr√≠guez', absences: 3 }, // Alerta
      { name: 'Mar√≠a P√©rez', absences: 0 }
    ];

    function checkAttendanceAlerts() {
      const container = document.getElementById('dashboardAlerts');
      const alerts = attendanceHistory.filter(s => s.absences >= 3);
      
      if (alerts.length > 0) {
        container.classList.remove('hidden');
        container.innerHTML = `
          <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded shadow-sm flex items-start gap-3">
            <i data-lucide="alert-circle" class="text-red-600 w-6 h-6 mt-0.5"></i>
            <div>
              <h3 class="font-bold text-red-700">Alertas de Asistencia</h3>
              <p class="text-sm text-red-600 mb-2">Los siguientes estudiantes tienen 3 o m√°s faltas consecutivas:</p>
              <ul class="list-disc list-inside text-sm text-red-800">
                ${alerts.map(s => `<li><strong>${s.name}</strong> (${s.absences} faltas)</li>`).join('')}
              </ul>
            </div>
          </div>
        `;
      }
    }

    // --- L√ìGICA DE ESTUDIANTES (Agregar) ---
    window.openAddStudentModal = function() {
      // Limpiar campos
      ['stName','stAge','stSchedule','p1Name','p1Phone','p2Name','p2Phone','stAllergies','stBlood','stPickup'].forEach(id => {
        document.getElementById(id).value = '';
      });
      document.getElementById('modalAddStudent').classList.remove('hidden');
    };

    window.saveStudent = function() {
      const name = document.getElementById('stName').value;
      if(!name) { alert('El nombre es obligatorio'); return; }
      
      // Aqu√≠ ir√≠a la l√≥gica para guardar en backend/localStorage
      // Simulamos agregarlo a la tabla visualmente o a la DB local
      alert(`Estudiante ${name} agregado correctamente.`);
      document.getElementById('modalAddStudent').classList.add('hidden');
      // Opcional: recargar tabla de estudiantes
    };

    // --- L√ìGICA DE AULAS (Gesti√≥n Completa) ---
    let roomsData = [
      { id: 1, name: 'Aula Peque√±os A1', teacher: 'Carolina Mart√≠nez', capacity: 15, students: ['Mar√≠a Fernanda P√©rez', 'Ana Sof√≠a Gonz√°lez'] },
      { id: 2, name: 'Aula Medianos B1', teacher: 'Andr√©s P√©rez', capacity: 18, students: ['Javier Rodr√≠guez'] }
    ];

    function renderRooms() {
      const tbody = document.getElementById('roomsTable');
      if(!tbody) return;
      tbody.innerHTML = '';

      roomsData.forEach(r => {
        const occupation = r.students.length;
        const percentage = Math.round((occupation / r.capacity) * 100);
        let color = 'bg-blue-600';
        if(percentage > 80) color = 'bg-red-500';
        else if(percentage > 50) color = 'bg-yellow-500';

        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-100 hover:bg-slate-50';
        tr.innerHTML = `
          <td class="py-3 px-2 font-medium">${r.name}</td>
          <td class="py-3 px-2 text-slate-500 hidden md:table-cell">${r.teacher}</td>
          <td class="py-3 px-2 w-1/4">
            <div class="flex items-center gap-2">
              <div class="w-full bg-slate-200 rounded-full h-2.5"><div class="${color} h-2.5 rounded-full" style="width: ${percentage}%"></div></div>
              <span class="text-xs text-slate-600">${occupation}/${r.capacity}</span>
            </div>
          </td>
          <td class="py-3 px-2 text-center"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">Activa</span></td>
          <td class="py-3 px-2">
            <button class="text-blue-600 hover:text-blue-800 mr-2" data-action="edit" data-id="${r.id}">Editar</button>
            <button class="text-green-600 hover:text-green-800 mr-2" data-action="view" data-id="${r.id}">Ver</button>
            <button class="text-red-600 hover:text-red-800" data-action="delete" data-id="${r.id}">Eliminar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      if(window.lucide) lucide.createIcons();
    }

    // Delegaci√≥n de eventos para evitar dependencias de funciones globales
    (function initRoomsDelegation(){
      const tbody = document.getElementById('roomsTable');
      if(!tbody || tbody.dataset.delegation === '1') return;
      tbody.dataset.delegation = '1';
      tbody.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-action]');
        if(!btn) return;
        const action = btn.dataset.action;
        const id = parseInt(btn.dataset.id, 10);
        if(action === 'edit') {
          if(typeof window.editRoom === 'function') window.editRoom(id);
          else alert('Funci√≥n editar aula no disponible todav√≠a.');
        } else if(action === 'view') {
          if(typeof window.viewRoomStudents === 'function') window.viewRoomStudents(btn);
          else alert('Funci√≥n ver estudiantes no disponible todav√≠a.');
        } else if(action === 'delete') {
          if(typeof window.deleteRoom === 'function') window.deleteRoom(id);
          else alert('Funci√≥n eliminar aula no disponible todav√≠a.');
        }
      });
    })();

    window.openRoomModal = function() {
      document.getElementById('roomId').value = '';
      document.getElementById('roomName').value = '';
      document.getElementById('roomTeacher').value = '';
      document.getElementById('roomCapacity').value = '';
      document.getElementById('roomModalTitle').innerText = 'Crear Aula';
      renderStudentChecklist([]);
      document.getElementById('roomModal').classList.remove('hidden');
    };

    window.editRoom = function(id) {
      const r = roomsData.find(x => x.id === id);
      if(!r) return;
      document.getElementById('roomId').value = r.id;
      document.getElementById('roomName').value = r.name;
      document.getElementById('roomTeacher').value = r.teacher; // Asegurarse que el value coincida con las opciones del select
      document.getElementById('roomCapacity').value = r.capacity;
      document.getElementById('roomModalTitle').innerText = 'Editar Aula';
      renderStudentChecklist(r.students);
      document.getElementById('roomModal').classList.remove('hidden');
    };

    window.deleteRoom = function(id) {
      if(confirm('¬øEliminar esta aula?')) {
        roomsData = roomsData.filter(x => x.id !== id);
        renderRooms();
      }
    };

    window.saveRoom = function() {
      const id = document.getElementById('roomId').value;
      const name = document.getElementById('roomName').value;
      const teacher = document.getElementById('roomTeacher').value;
      const capacity = document.getElementById('roomCapacity').value;
      
      // Recoger estudiantes seleccionados
      const selectedStudents = [];
      document.querySelectorAll('#roomStudentsChecklist input:checked').forEach(cb => {
        selectedStudents.push(cb.value);
      });

      if(!name) { alert('Nombre del aula requerido'); return; }

      const newData = {
        id: id ? parseInt(id) : Date.now(),
        name, teacher, capacity, students: selectedStudents
      };

      if(id) {
        const idx = roomsData.findIndex(x => x.id == id);
        if(idx >= 0) roomsData[idx] = newData;
      } else {
        roomsData.push(newData);
      }
      renderRooms();
      document.getElementById('roomModal').classList.add('hidden');
    };

    function renderStudentChecklist(currentStudents = []) {
      const container = document.getElementById('roomStudentsChecklist');
      container.innerHTML = '';
      // Usamos las claves de studentsDb como lista de estudiantes disponibles
      Object.keys(studentsDb).forEach(stName => {
        const isChecked = currentStudents.includes(stName) ? 'checked' : '';
        const div = document.createElement('div');
        div.innerHTML = `<label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-slate-100 p-1 rounded"><input type="checkbox" value="${stName}" ${isChecked} class="rounded text-blue-600"> <span>${stName}</span></label>`;
        container.appendChild(div);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      initChart();
      initNavigation();
      initPaymentsChart();
      renderPaymentsTable();
      renderTeachers(); // Renderizar maestros al inicio
      renderGrades(); // Renderizar calificaciones
      renderRooms(); // Renderizar aulas
      checkAttendanceAlerts(); // Verificar alertas
      if (window.lucide) lucide.createIcons();
    });
  </script>
</body>
</html>
